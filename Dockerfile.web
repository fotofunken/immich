# production-builder-base image 
FROM ghcr.io/immich-app/base-server-dev:202508191104@sha256:0608857ef682099c458f0fb319afdcaf09462bbb5670b6dcd3642029f12eee1c AS prod-builder-base 

ENV COREPACK_ENABLE_DOWNLOAD_PROMPT=0 \
    CI=1 \
    COREPACK_HOME=/tmp 

RUN npm install --global corepack@latest && \
    corepack enable pnpm 

# web production build 
FROM prod-builder-base AS web-prod 
WORKDIR /usr/src/app 

# Kopiere alle root-Dateien, die für den Monorepo- und Web-Build benötigt werden
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .pnpmfile.cjs mise.toml* ./

# Kopiere den gesamten web-Ordner (da du mehr Dateien änderst – sicherer als selektiv)
COPY web/ ./web/

# Kopiere weitere Ordner, die das Web braucht (i18n für Übersetzungen, open-api für SDK)
COPY i18n/ ./i18n/
COPY open-api/ ./open-api/

# Optional: wenn notwendig für root-Configs wie tsconfig, vite.config usw. für Web
# COPY tsconfig.json vite.config.ts* ./

RUN SHARP_IGNORE_GLOBAL_LIBVIPS=true pnpm --filter @immich/sdk --filter immich-web --frozen-lockfile --force install && \
    pnpm --filter @immich/sdk --filter immich-web build 

RUN ls -la web/build  # Debug: Zeigt, ob der Build-Ordner da ist

# Final: Leichtes Nginx-Image
FROM nginx:alpine  # Noch kleiner als normales nginx
COPY --from=web-prod /usr/src/app/web/build /usr/share/nginx/html